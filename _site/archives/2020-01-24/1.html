<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>ModSecurity 拒绝服务漏洞 (CVE-2019-19886) 复现 · Chen's Blog</title> <meta name="description" content="ModSecurity 拒绝服务漏洞 (CVE-2019-19886) 复现"> <link rel="icon" href="http://localhost:4000/assets/favicon.png"> <link rel="apple-touch-icon" href="http://localhost:4000/assets/touch-icon.png"> <link rel="stylesheet" href="http://localhost:4000/assets/core.css"> <link rel="canonical" href="http://localhost:4000/archives/2020-01-24/1"> <link rel="alternate" type="application/atom+xml" title="Chen's Blog" href="http://localhost:4000/feed.xml" /> <link href="/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" media="all" /> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e4a42a371cc5994ee02b940034c29658"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <aside class="logo"> <a href="http://localhost:4000/"> <img src="/assets/avatar.jpg" class="logo-avatar"> </a> <span class="logo-prompt code">Back to Index</span> </aside> <article> <h1 class="title">Author[#]Vulkey_Chen</h1> <div class="divider"></div> <center><a href="/about">关于我</a> | <a href="/links">友情链接</a> | <a href="/AssistTool">Windows进程对比杀软信息&辅助提权补丁对比</a></center> <div class="divider"></div> </article> <div id="content"> <article> <div class="center"> <h1 class="title">ModSecurity 拒绝服务漏洞 (CVE-2019-19886) 复现</h1> <time class="code">January 24, 2020</time> </div> <div class="divider"></div> <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&auto=1&id=65795&height=66"></iframe> <h1 id="modsecurity-拒绝服务漏洞-cve-2019-19886-复现">ModSecurity 拒绝服务漏洞 (CVE-2019-19886) 复现</h1> <p>作者: key</p> <p>本文利用Github Commit代码对比的方式进行跟踪复现</p> <h2 id="背景">背景</h2> <blockquote> <p>2020年1月20日，Trustwave SpiderLabs公开了其维护的开源WAF引擎ModSecurity的1个拒绝服务（DoS）漏洞，漏洞编号为：CVE-2019-19886。此漏洞影响ModSecurity的3.0到3.0.3版本。</p> </blockquote> <h2 id="漏洞描述">漏洞描述</h2> <blockquote> <p>ModSecurity是一个开源的、跨平台的Web应用防火墙（WAF），被称为WAF界的“瑞士军刀”。它可以通过检查Web服务接收到的数据，以及发送出去的数据来对网站进行安全防护。</p> <p>2020年1月21日，ModSecurity的维护组织Trustwave公开了影响ModSecurity 3.0至3.0.3版本的1个拒绝服务漏洞，漏洞编号为 CVE-2019-19886，漏洞详情如下：</p> <p>在ModSecurity 3.0到3.0.3版本中，存在cookie解析问题。通过构造格式错误的HTTP Cookie头发送到运行ModSecurity的Nginx的服务器，会导致out_of_range异常。在结合Nginx web服务器使用ModSecurity的常用情况下，该异常将使nginx工作线程（负责处理请求的线程）崩溃。不断向服务器发送此类请求将使工作线程反复崩溃。如果发送请求的速度快于工作线程恢复的速度，将导致服务器拒绝服务。</p> </blockquote> <h2 id="漏洞跟踪">漏洞跟踪</h2> <p>通过Github项目的releases跟踪: https://github.com/SpiderLabs/ModSecurity/releases</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797000068737.jpg" alt="-w993" /></p> <p>发现了airween的一个pr: https://github.com/SpiderLabs/ModSecurity/pull/2201</p> <p>被官方采纳并归并到了<code class="language-plaintext highlighter-rouge">v3/master</code></p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797001388668.jpg" alt="-w830" /></p> <p>来看看他究竟修改了什么: https://github.com/SpiderLabs/ModSecurity/pull/2201/commits/c7ad6c7613de3c1ac2ad1b4055f0ded22b522027</p> <p>存在漏洞的代码如下：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797004167746.jpg" alt="-w635" /></p> <p>可以看见这里将Cookie的值带入代码，先以<code class="language-plaintext highlighter-rouge">;</code>符号进行分割，进入for循环，再以<code class="language-plaintext highlighter-rouge">=</code>符号进行分割赋值，而后使用正常数组下标的表达方式进入功能中，那么问题出在了哪里？</p> <p>我们再来看修复的代码：</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797006105146.jpg" alt="-w717" /></p> <p>简单阅读代码和注释就能了解到，它就是处理两种非正常的Cookie值: <code class="language-plaintext highlighter-rouge">Cookie: ;;foo=bar</code> \ <code class="language-plaintext highlighter-rouge">Cookie: =bar;</code></p> <p>换句话说就是ModSecurity原来在处理Cookie内容的时候过于信任用户的输入，这也是安全的一个大忌讳: <strong>一切用户的输入都是不可信的</strong>！</p> <p>为什么会拒绝服务呢？可以理解为数组越界，类似:</p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797060724502.jpg" alt="-w803" /></p> <h2 id="漏洞测试">漏洞测试</h2> <p>很明显，通过漏洞跟踪已经知道了漏洞攻击方式那就是构建恶意(畸形)的<code class="language-plaintext highlighter-rouge">Cookie</code>头</p> <p>Curl命令测试: <code class="language-plaintext highlighter-rouge">curl -s -H 'Cookie: =test' 'http://test/'</code></p> <p><img src="https://chen-blog-oss.oss-cn-beijing.aliyuncs.com/2020-01-24/15797057266076.jpg" alt="-w1067" /></p> <p>根据奇安信CERT的描述: <code class="language-plaintext highlighter-rouge">不断向服务器发送此类请求将使工作线程反复崩溃</code>，那我们可以重复这个请求造成拒绝服务效果。</p> <h2 id="reference">Reference</h2> <p>奇安信CERT: https://mp.weixin.qq.com/s/MwGroFA_sKxzrwXa50XZgw</p> <p>Github: https://github.com/SpiderLabs/ModSecurity/pull/2201/commits/c7ad6c7613de3c1ac2ad1b4055f0ded22b522027</p> </article> <div class="page-navigation code"> <a class="next" href="http://localhost:4000/archives/2020-02-13/1" title="NEXT: BurpSuite系列 | 基础技巧（一）">&lt;&lt;</a> <span> &middot; </span> <a class="home" href="http://localhost:4000/" title="Back to Index">Index</a> <span> &middot; </span> <a class="prev" href="http://localhost:4000/archives/2020-01-08/3" title="PREV: [XSSI]动态JS劫持用户信息">&gt;&gt;</a> </div> </div> <div class="footer"> <span class="block">&lt;/&gt; Copyright &copy; Vulkey_Chen's Blog (GH0ST.CN) 2016-2020</span> </div> <script src="/fancybox/lib/jquery-1.10.2.min.js"></script> <script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script> <script> $(document).ready(function() { $("article img").each(function() { var strA = "<a style='text-decoration: none;' id='imgid' href='" + this.src + "'></a>"; $(this).wrapAll(strA); }); }); $("#imgid").fancybox({ openEffect : 'elastic', closeEffect : 'elastic', }); </script> </body> </html>
